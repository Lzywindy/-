**<center><font face="微软雅黑" size=10>三维弹道提前量计算(无风阻条件)</font></center>**

# 问题背景

在游戏中，遇到仿真的物理环境时，往往在战斗中需要计算弹道，而在游戏中能够获取的就是：当地的重力加速度、目标的速度和原始位置、自己的速度和原始位置、炮弹的初速率（标量），用这些来估计提前量，以求接近真实视觉效果:)。

大部分游戏是不会考虑风阻这项因素的，因此我们就在这里省略了这个项目。

# 符号定义

- $v_{target}$: 目标速度，可表示为$(x_{v_{target}},y_{v_{target}},z_{v_{target}})$
- $P_{target}$: 目标现在的位置，可表示为$(x_{P_{target}},y_{P_{target}},z_{P_{target}})$
- $v_{project}$: 弹头的初速度，可表示为$(x_{v_{project}},y_{v_{project}},z_{v_{project}})$
- $v_{me}$: 发射弹头的物体的速度，可表示为$(x_{v_{me}},y_{v_{me}},z_{v_{me}})$
- $g$: 当前作战区域的重力场，可表示为$(x_{g},y_{g},z_{g})$
- $P_{me}$: 发射弹头的物体当前的坐标，可表示为$(x_{P_{me}},y_{P_{me}},z_{P_{me}})$
- $P'_{target}$: 目标的位置，可表示为$(x_{P'_{target}},y_{P'_{target}},z_{P'_{target}})$
- $t$: 弹头和目标相遇经历的时间，是个标量

# 结果过程

问题公式表示

$$P'_{target}=\int^{t}_{0}v_{target}dt+P_{target} \tag{1}$$
$$P'_{target}=\int^{t}_{0}(v_{me}+v_{project}+\int^{t}_{0}gdt)dt+P_{me}\tag{2}$$

由于(1)和(2)都算出的是$P'_{target}$且所经历的时间都是$t$，因此开始调整合并运算方程为：

$$v_{target}t+P_{target}=v_{me}t+v_{project}t+\frac{1}{2}gt^{2}+P_{me}\tag{3}$$

已知弹头初速的长度为$\sqrt {||v_{project}||^2}$，但是方向未知，那么继续调整方程：
$$v_{project}t=(P_{target}-P_{me})+(v_{target}-v_{me})t-\frac{1}{2}gt^{2}\tag{4}$$

将方程写成对应坐标的方程：

$$\begin{cases}x_{v_{project}}t=(x_{v_{project}}-x_{P_{me}})+(x_{v_{target}}-x_{v_{me}})t-\frac{1}{2}x_{g}t^{2}\\
y_{v_{project}}t=(y_{v_{project}}-y_{P_{me}})+(y_{v_{target}}-y_{v_{me}})t-\frac{1}{2}y_{g}t^{2}\\
z_{v_{project}}t=(z_{v_{project}}-z_{P_{me}})+(z_{v_{target}}-z_{v_{me}})t-\frac{1}{2}z_{g}t^{2}
\end{cases}\tag{5}$$

方程两边同时平方可得：
$${||v_{project}||}^{2}{t}^{2}={||P_{target}-P_{me}||}^{2}+{||v_{target}-v_{me}||}^{2}{t}^{2}\\+\frac{1}{4}{||g||}^{2}{t}^{4}+(P_{target}-P_{me})\cdot(v_{target}-v_{me})t\\- \frac{1}{2}(P_{target}-P_{me})\cdot gt^{2}-\frac{1}{2}(v_{target}-v_{me}) \cdot gt^{3} \tag{6}$$

令：
$$dis=P_{target}-P_{me}\tag{7}$$
$$v_{r}=v_{target}-v_{me}\tag{8}$$
带入原方程得：
$${||v_{project}||}^{2}{t}^{2}={||dis||}^{2}+{||v_{r}||}^{2}{t}^{2}\\+\frac{1}{4}{||g||}^{2}{t}^{4}+dis\cdot(v_{r})t\\- \frac{1}{2}dis\cdot gt^{2}-\frac{1}{2}(v_{r}) \cdot gt^{3} \tag{9}$$
变成一元四次方程组:

$$\frac{1}{4}{||g||}^{2}{t}^{4}-\frac{1}{2}v_{r}\cdot gt^{3}+({||v_{r}||}^{2}-\frac{1}{2}dis\cdot g\\-{||v_{project}||}^{2}){t}^{2}+dis\cdot(v_{r})t+{||dis||}^{2}=0 \tag{10}$$

当重力 $g$为0的时候(太空中，空域平坦区域)，方程课简化为：

$$({||v_{r}||}^{2}-{||v_{project}||}^{2}){t}^{2}+dis\cdot(v_{r})t+{||dis||}^{2}=0 \tag{11}$$

# 解方程过程

## 考虑重力的情况

由公式10可知，我们将最高次项得系数变为1，可得

$${t}^{4}-\frac{2v_{r}g}{{||g||}^{2}}t^{3}+\frac{(4{||v_{r}||}^{2}-2dis\cdot g-4{||v_{project}||}^{2})}{{||g||}^{2}}{t}^{2}\\+\frac{4dis\cdot(v_{r})}{{||g||}^{2}}t+\frac{4{||dis||}^{2}}{{||g||}^{2}}=0 \tag{12}$$

令系数为：

$$\begin{cases}
a=1\\
b=-\frac{2v_{r}g}{{||g||}^{2}}\\
c=\frac{(4{||v_{r}||}^{2}-2dis\cdot g-4{||v_{project}||}^{2})}{{||g||}^{2}}\\
d=\frac{4dis\cdot(v_{r})}{{||g||}^{2}}\\
e=\frac{4{||dis||}^{2}}{{||g||}^{2}}
\end{cases}\tag{13}$$

因此我们可以将12式用13去替换为：

$${t}^{4}+bt^{3}+c{t}^{2}+dt+e=0 \tag{14}$$

此时，由于4次方程求解较为困难，我们设：

$$f(t)={t}^{4}+bt^{3}+c{t}^{2}+dt+e \tag{15}$$

然后用泰勒级数展开并保留其一阶展开式，并使之为0：

$$f(t_{0})+(t-t_{0})\dot{f(t)}=0 \tag{16}$$

因此可得牛顿迭代式为：

$$t_{n+1}=t_{n}-\frac{f(t_{n})}{\dot{f(t_{n})}}$$
$$\Downarrow$$
$$t_{n+1}=t_{n}-\frac{{t_{n}}^{4}+b{t_{n}}^{3}+c{t_{n}}^{2}+dt_{n}+e}{4{t_{n}}^{3}+3b{t_{n}}^{2}+2ct_{n}+d}$$
$$\Downarrow$$
$$t_{n+1}=\frac{3{t_{n}}^{4}+2b{t_{n}}^{3}+c{t_{n}}^{2}-e}{4{t_{n}}^{3}+3b{t_{n}}^{2}+2ct_{n}+d}\tag{17}$$

最终可通过多次迭代公式17完成对时间的较为精确的估计。具体的迭代参数则需要实践来证明。

最后，时间的近似逼近可以写作：

$$\begin{cases}
t_{n+1}=\frac{3{t_{n}}^{4}+2b{t_{n}}^{3}+c{t_{n}}^{2}-e}{4{t_{n}}^{3}+3b{t_{n}}^{2}+2ct_{n}+d}\\
t_{n+1} > 0\\
4{t_{n}}^{3}+3b{t_{n}}^{2}+2ct_{n}+d \neq 0
\end{cases}\tag{18}$$

此时，我们计算火炮炮弹的速度方向，将 $t=t_{n+1}+\Delta{t}$ 代入公式4中，可得：

$$\begin{cases}v_{project}=\frac{P_{target}-P_{me}}{t}+(v_{target}-v_{me})-\frac{1}{2}gt\\
t=t_{n+1}+\Delta{t}>0
\end{cases}\tag{19}$$


其中$\Delta{t}$是最终式子中对于时间的补正，用于修正落点，$n$为迭代次数，到此为止，炮弹的初速$v_{project}$算是得到了,但是我们最终只取其方向，其大小我们已经知道为一个固定的数值（对于同种类型的炮弹、和装药量而言）。

迭代的$t$的初值可大致估计为 $t_0=\frac{1.3dis}{||v_r||}$，大概就可以在 $n=5$ 步左右收敛。

总结：在有重力的条件下，公式18为推导出来的迭代方程，最终的结果满足客观要求后，再和19，算出炮弹初速的方向，最后让炮口的方向与炮弹初速方向一致，便可以得到一个较好的效果了。

## 不考虑重力的情况

忽略重力的情况有：脱壳稳定尾翼穿甲弹（这个在游戏里的弹道是条射线）、重力圈之外，引力极小的地区、或者无制导稳向火箭弹（等）。

由公式11可知道，这个是个一元二次方程，我们可以解出精确解，令：

$$\begin{cases}
a={||v_{r}||}^{2}-{||v_{project}||}^{2}\\
b=dis\cdot(v_{r})\\
c={||dis||}^{2}
\end{cases}\tag{20}$$

可以得到解为：

$$\begin{cases}
t=\frac{-b\pm \sqrt{b^2-4ac}}{2a}\\
t>0\\
b^2-4ac \geq 0
\end{cases}\tag{21}$$

最后将 $t$ 代回4中可得：

$$\begin{cases}v_{project}=\frac{P_{target}-P_{me}}{t}+(v_{target}-v_{me})-\frac{1}{2}gt\\
t=t_{n+1}+\Delta{t}>0
\end{cases}\tag{22}$$

其中$\Delta{t}$是最终式子中对于时间的补正，用于修正落点。

总结：在无重力（或者忽视重力）的条件下，公式21为推导出来的迭代方程，最终的结果满足客观要求后，再和22，算出炮弹初速的方向，最后让炮口的方向与炮弹初速方向一致，便可以得到一个较好的效果了。

# 总结

游戏中的炮弹弹道的计算，可以分为这两种情况，与真实中有一定差距（毕竟我现在玩国地游戏中对于炮弹或者子弹没有风速、风阻这个概念），由于计算比较消耗资源，因此在制作其他游戏中，可以考虑采用异步线程来进行计算，稍微复杂一些的话可以考虑采用一些加速库来实现。






